<?xml version="1.0" encoding="utf-8" standalone="yes"?>
<?xml-stylesheet type="text/xsl" href="modx.prosilver.en.xsl"?>
<!--For security purposes, please check: http://www.phpbb.com/mods/ for the latest version of this MOD. Although MODs are checked before being allowed in the MODs Database there is no guarantee that there are no security problems within the MOD. No support will be given for MODs not found within the MODs Database which can be found at http://www.phpbb.com/mods/-->
<mod xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns="http://www.phpbb.com/mods/xml/modx-1.2.5.xsd">
<header>
	<license>http://opensource.org/licenses/gpl-license.php GNU General Public License v2</license>

	<title lang="en">Topic Age Warning</title>
	
	<description lang="en">This MOD displays a warning to members when they attempt to reply to a topic that has had no replies for a specified amount of time. This can be set via the ACP.</description>

	<author-notes lang="en">This MOD is currently in the BETA stage and should NOT be used in a live environment. You are, however, welcome to use it on a test board.
	If you would like to make a donation for my work done on this MOD as well as other MODs, you may do so by going to the demo/test board (http://www.phpbbdevelopers.net/) and clicking the Donate button in the header. All donations are voluntary but appreciated.</author-notes>

	<author-group>
		<author>
			<username>imkingdavid</username>
			<realname>David King</realname>
			<homepage>http://www.phpbbdevelopers.net</homepage>
			<email>imkingdavid@gmail.com</email>
		</author>
	</author-group>

	<mod-version>1.0.0</mod-version>

	<installation>
		<level>intermediate</level>
		<time>300</time>
		<target-version>3.0.7-PL1</target-version>
	</installation>
	<history>
		<entry>
			<date>2010-05-03</date>
			<rev-version>0.0.0 DEV</rev-version>
			<changelog lang="en">
				<change>Begun development</change>
			</changelog>
		</entry>
	</history>
</header>

<action-group>
	<copy>
		<file from="root/*.*" to="*.*" />
	</copy>
	<open src="styles/prosilver/template/posting_editor.html">
		<edit>
			<find><![CDATA[	<!-- IF ERROR --><p class="error">{ERROR}</p><!-- ENDIF -->]]></find>
			<action type="after-add"><![CDATA[    <!-- IF S_TOPIC_AGE_WARNING --><p class="error">{TOPIC_AGE_WARNING}</p><!-- ENDIF -->]]></action>
		</edit>
	</open>
	<open src="includes/acp/acp_board.php">
		<edit>
			<find><![CDATA['legend3'					=> 'ACP_SUBMIT_CHANGES',]]></find>
			<action type="before-add"><![CDATA[						'legend4'					=> 'TOPIC_AGE_WARNING',
						'taw_interval_type'		=> false,
						'taw_interval'			=> array('lang' => 'TAW_INTERVAL',			'validate' => 'int:0',		'type' => 'custom', 'method' => 'taw_interval', 'explain' => true),
						'taw_lock'				=> array('lang' => 'TAW_LOCK',				'validate' => 'bool',		'type' =>     'radio:yes_no', 'explain' => true),
						'taw_author_exempt'		=> array('lang' => 'TAW_AUTHOR_EXEMPT',		'validate' => 'bool',		'type' => 'radio:yes_no', 'explain' => true),
						'taw_last_post'			=> array('lang' => 'TAW_LAST_POST',			'validate' => 'bool',		'type' => 'radio:yes_no', 'explain' => true),]]></action>
		</edit>
		<edit>
			<find><![CDATA[/**
	* Select bump interval
	*/
	function bump_interval($value, $key)
	{
		global $user;

		$s_bump_type = '';
		$types = array('m' => 'MINUTES', 'h' => 'HOURS', 'd' => 'DAYS');
		foreach ($types as $type => $lang)
		{
			$selected = ($this->new_config['bump_type'] == $type) ? ' selected="selected"' : '';
			$s_bump_type .= '<option value="' . $type . '"' . $selected . '>' . $user->lang[$lang] . '</option>';
		}

		return '<input id="' . $key . '" type="text" size="3" maxlength="4" name="config[bump_interval]" value="' . $value . '" />&nbsp;<select name="config[bump_type]">' . $s_bump_type . '</select>';
	}]]></find>
			<action type="after-add"><![CDATA[/**
	* Select Topic Age Warning interval
	*/
	function taw_interval($value, $key)
	{
		global $user;

		$s_taw_type = '';
		$types = array('d' => 'DAYS', 'm' => 'MONTHS', 'y' => 'YEARS');
		foreach ($types as $type => $lang)
		{
			$selected = ($this->new_config['taw_interval_type'] == $type) ? ' selected="selected"' : '';
			$s_taw_type .= '<option value="' . $type . '"' . $selected . '>' . $user->lang[$lang] . '</option>';
		}

		return '<input id="' . $key . '" type="text" size="3" maxlength="4" name="config[taw_interval]" value="' . $value . '" />&nbsp;<select name="config[taw_interval_type]">' . $s_taw_type . '</select>';
	}]]></action>
		</edit>
	</open>
	<open src="language/en/common.php">
		<edit>
			<find><![CDATA[	'TOPIC'				=> 'Topic',
	'TOPICS'			=> 'Topics',]]></find>
			<action type="after-add"><![CDATA[//! Topic Age Warning - imkingdavid
	'TOPIC_AGE_WARNING'	=> 'You are attempting to reply to a topic that is %s old. Instead, please begin a new topic, or search for another related topic that may be more suitable.',
	'TOPIC_AGE_WARNING_LOCK'	=> 'This topic is %s old. The forum administrator has chosen for old topics to be locked when a reply is attempted. Please begin a new topic or use the search feature to find a similar but newer topic.',
	//! END Topic Age Warning - imkingdavid]]></action>
		</edit>
	</open>
	<open src="language/en/acp/board.php">
		<edit>
			<find><![CDATA[	'BUMP_INTERVAL'					=> 'Bump interval',
	'BUMP_INTERVAL_EXPLAIN'			=> 'Number of minutes, hours or days between the last post to a topic and the ability to bump this topic.',]]></find>
			<action type="after-add"><![CDATA[//! Topic Age Warning - imkingdavid
	'TOPIC_AGE_WARNING'				=> 'Topic Age Warning Settings',
	'TAW_INTERVAL'					=> 'Topic Age Warning interval',
	'TAW_INTERVAL_EXPLAIN'			=> 'Number of days, months or years after which a user will recieve the topic age warning. <strong>If set to 0, the MOD will be disabled.</strong>',
	'TAW_LOCK'						=> 'Lock old topic',
	'TAW_LOCK_EXPLAIN'				=> 'If \'Yes\', topics to which a user attempts to reply after the set interval will be automatically locked.',
	'TAW_AUTHOR_EXEMPT'				=> 'Exempt author from Topic Age Warning',
	'TAW_AUTHOR_EXEMPT_EXPLAIN'		=> 'If \'Yes\', the author of the topic will be able to reply to their own topics, even after the set interval is passed.',
	'TAW_LAST_POST'					=> 'Use Last Reply time',
	'TAW_LAST_POST_EXPLAIN'			=> 'If \'Yes\', the old topics will be determined using the time of the last reply to the topic. If \'No\', old topics will be determined using the time of the topic\'s creation.',
	'MONTHS'						=> 'Months',
	'YEARS'							=> 'Years',
	//! END Topic Age Warning - imkingdavid]]></action>
		</edit>
	</open>
	<open src="posting.php">
		<edit>
			<find><![CDATA[//! Topic Age Warning - imkingdavid
//! Is the topic too old?
/*
Configs:
taw_interval (integer) Interval (NOTE: A value of 0, or false, disables the MOD)
taw_interval_type (string) d (Day) m (Month) y (Year)
taw_last_post (bool) If true, base interval on last post time; else base on original topic creation time
taw_lock (bool) Lock the topic if triggered?
taw_author_exempt (bool) Exempt topic author?
*/
$current_time = time();
$interval_value = $config['taw_interval'];
$interval_type = $config['taw_interval_type'];
$interval = 0;
switch($interval_type)
{
	default:
	case 'y':
		$interval = $interval_value * (60*60*24*365);
		break;
	case 'd':
		$interval = $interval_value * (60*60*24);
		break;
	case 'm':
		$interval = $interval_value * (60*60*24*31);
		break;
}
$check_time = $post_data[ ($config['taw_last_post']) ? 'topic_last_post_time' : 'topic_time' ];
$current_interval = $current_time - $check_time;
$pretty_interval = compare_dates($check_time, $current_time);
$author_exempt = (($post_data['topic_poster'] === $user->data['user_id']) && $config['taw_author_exempt']) ? true : false;
//! Time for the longest conditional you've ever seen!
if($mode == 'reply' && !$author_exempt && $interval && !$auth->acl_get('m_', $forum_id) && ($current_interval > $interval))
{
	if($config['taw_lock'])
	{
		//do topic locking stuff.
		$sql = 'UPDATE ' . TOPICS_TABLE . '
				SET topic_status = ' . ITEM_LOCKED . "
				WHERE topic_id = $topic_id
					AND topic_moved_id = 0";
		$result = $db->sql_query($sql);
		$message = sprintf($user->lang['TOPIC_AGE_WARNING_LOCK'], $pretty_interval);
		trigger_error($message);
	}
	else
	{
		$message = sprintf($user->lang['TOPIC_AGE_WARNING'], $pretty_interval);
		$template->assign_vars(array(
			'S_TOPIC_AGE_WARNING'	=> true,
			'TOPIC_AGE_WARNING'		=> $message,
		));
	}
}
// METHOD STOLEN FROM http://php.net/manual/en/ref.datetime.php
function compare_dates($date1, $date2) 
{ 
	$blocks = array( 
		array('name'=>'year','amount'	=> 60*60*24*365 ), 
		array('name'=>'month','amount'	=> 60*60*24*31 ), //2678400 
		array('name'=>'week','amount'	=> 60*60*24*7 ), 
		array('name'=>'day','amount'	=> 60*60*24 ), 
		array('name'=>'hour','amount'   => 60*60 ), 
		array('name'=>'minute','amount' => 60 ), 
		array('name'=>'second','amount' => 1 ) 
		); 
	
	$diff = abs($date1-$date2); 
	
	$levels = 2; 
	$current_level = 1; 
	$result = array(); 
	foreach($blocks as $block) 
	{ 
		if ($current_level > $levels)
		{
			break;
		}
		if ($diff/$block['amount'] >= 1) 
		{ 
			$amount = floor($diff/$block['amount']); 
			if ($amount>1)
			{
				$plural='s';
			}
			else
			{
				$plural='';
			} 
			$result[] = $amount.' '.$block['name'].$plural; 
			$diff -= $amount*$block['amount']; 
			$current_level++; 
		} 
	} 
	return implode(' and ',$result); 
}
//! END Topic Age Warning - imkingdavid]]></action>
		</edit>
	</open>
	<open src="styles/prosilver/template/posting_editor.html">
		<edit>
			<find><![CDATA[	<!-- IF ERROR --><p class="error">{ERROR}</p><!-- ENDIF -->]]></find>
			<action type="after-add"><![CDATA[    <!-- IF S_TOPIC_AGE_WARNING --><p class="error">{TOPIC_AGE_WARNING}</p><!-- ENDIF -->]]></action>
		</edit>
	</open>
	<php-installer>taw_install.php</php-installer>
	<diy-instructions lang="en"><![CDATA[Development of MODs occurs during my free time. While I enjoy coding, it has to come as a second priority to any paying jobs. However, if I recieve donations I am more willing to do more work to compensate. If you feel willing to donate, please follow the instructions at the test board (http://www.phpbbdevelopers.net/). Thanks!]]>
	</diy-instructions>
</action-group>
</mod>